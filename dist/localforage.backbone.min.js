!function(a,b){if("function"==typeof define&&define.amd)define(["localforage","backbone","underscore"],b);else if("undefined"!=typeof module&&module.exports){var c=require("localforage"),d=require("backbone"),e=require("underscore");module.exports=b(c,d,e)}else b(a.localforage,a.Backbone,a._)}(this,function(a,b,c){function d(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function e(){return d()+d()+"-"+d()+"-"+d()+"-"+d()+"-"+d()+d()+d()}return b.kangoforage={localforageInstance:a,sync:function(a){var c=this,d=function(d,f,g){switch(this instanceof b.Collection?f.sync.localforageKey=a:(f.id||(f[this.idAttribute]=f.attributes[this.idAttribute]=e()),f.sync.localforageKey=a+"/"+f.id),d){case"read":return f.id?c.find(f,g):c.findAll(f,g);case"create":return c.create(f,g);case"update":return c.update(f,g);case"delete":return c.destroy(f,g)}};return d._localforageNamespace=a,d},save:function(a,b){kango.invokeAsyncCallback("localforage.setItem",a.sync.localforageKey,a.toJSON(),function(d){if(a.collection){var e=a.collection,f=e.map(function(a){return e.model.prototype.sync._localforageNamespace+"/"+a.id});b=b?c.partial(b,d):void 0,kango.invokeAsyncCallback("localforage.setItem",a.collection.sync.localforageKey,f,b)}else b&&b(d)})},create:function(a,b){return this.update(a,b)},update:function(a,b){this.save(a,function(a){b.success&&b.success(a)})},find:function(a,b){kango.invokeAsyncCallback("localforage.getItem",a.sync.localforageKey,function(a){c.isEmpty(a)?b.error&&b.error():b.success&&b.success(a)})},findAll:function(a,b){kango.invokeAsyncCallback("localforage.getItem",a.sync.localforageKey,function(a){if(a&&a.length){var d=function(){b.success&&b.success(a)};d=c.after(a.length,d);for(var e=function(b,c){a[b]=c,d()},f=0;f<a.length;++f)kango.invokeAsyncCallback("localforage.getItem",a[f],c.partial(e,f))}else a=[],b.success&&b.success(a)})},destroy:function(a,b){kango.invokeAsyncCallback("localforage.removeItem",a.sync.localforageKey,function(){var c=a.toJSON();b.success&&b.success(c)})}},b.kangoforage});